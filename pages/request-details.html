<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Request Details | Leave Portal</title>
    <link rel="stylesheet" href="../css/style.css">
    <script src="https://unpkg.com/lucide@latest"></script>
</head>

<body class="bg-[#0f172a] dark:bg-gray-950 min-h-screen flex items-center justify-center p-4">
    <!-- Back button floating -->
    <button id="back-btn"
        class="fixed top-6 left-6 p-3 bg-white/10 hover:bg-white/20 text-white rounded-full transition-all backdrop-blur-md z-50">
        <i data-lucide="arrow-left" class="w-6 h-6"></i>
    </button>

    <!-- Main Card (Reference Style) -->
    <div
        class="w-full max-w-2xl bg-[#1e293b] text-white rounded-2xl shadow-2xl overflow-hidden border border-gray-700 animate-in fade-in zoom-in duration-300 relative">
        <!-- Close button decoration -->
        <div class="absolute top-4 right-4 cursor-pointer opacity-50 hover:opacity-100 transition-opacity"
            onclick="document.getElementById('back-btn').click()">
            <i data-lucide="x" class="w-6 h-6"></i>
        </div>

        <div class="p-8 space-y-8">
            <!-- Header Section -->
            <header class="space-y-1">
                <h1 id="detail-title" class="text-2xl font-bold tracking-tight">Request Details</h1>
                <p class="text-gray-400 text-sm font-medium">From: <span id="detail-student-name"
                        class="text-white"></span></p>
            </header>

            <!-- Details Content -->
            <div class="space-y-8">
                <!-- Dates -->
                <section>
                    <h3 class="text-sm font-bold text-gray-500 uppercase tracking-widest mb-2">Dates</h3>
                    <p id="detail-date-summary" class="text-xl font-bold"></p>
                </section>

                <!-- Subject/Purpose -->
                <section>
                    <h3 class="text-sm font-bold text-gray-500 uppercase tracking-widest mb-2">Subject/Purpose</h3>
                    <p id="detail-subject" class="text-xl font-bold"></p>
                </section>

                <!-- Description -->
                <section>
                    <h3 class="text-sm font-bold text-gray-500 uppercase tracking-widest mb-2">Description</h3>
                    <p id="detail-reason" class="text-lg text-gray-300 leading-relaxed"></p>
                </section>

                <!-- Status -->
                <section>
                    <h3 class="text-sm font-bold text-gray-500 uppercase tracking-widest mb-3">Current Status</h3>
                    <div id="status-badge-custom"
                        class="w-full py-2 px-6 rounded-full text-center font-bold text-lg transition-colors">
                        <!-- Status text injected here -->
                    </div>
                </section>
            </div>

            <!-- Footer Meta -->
            <div class="pt-8 border-t border-gray-700/50 flex flex-wrap gap-6 text-xs text-gray-500">
                <div class="flex items-center gap-1.5">
                    <i data-lucide="hash" class="w-3 h-3"></i>
                    <span id="detail-request-id"></span>
                </div>
                <div class="flex items-center gap-1.5">
                    <i data-lucide="calendar" class="w-3 h-3"></i>
                    <span id="detail-applied-date"></span>
                </div>
                <div class="flex items-center gap-1.5">
                    <i data-lucide="layers" class="w-3 h-3"></i>
                    <span id="detail-dept"></span>
                </div>
                <div class="flex items-center gap-1.5">
                    <i data-lucide="user-check" class="w-3 h-3"></i>
                    <span id="detail-student-regno"></span>
                </div>
            </div>

            <!-- Action Panels and Export -->
            <div class="flex flex-col gap-4">
                <div id="action-panel" class="hidden pt-6 mt-6 border-t border-gray-700">
                    <h3 id="action-title" class="text-lg font-bold mb-4 text-indigo-400">Action Required</h3>
                    <div class="space-y-4">
                        <textarea id="remark" placeholder="Enter remark..."
                            class="w-full p-4 bg-gray-800 border-2 border-transparent focus:border-indigo-500 rounded-xl text-white outline-none h-24 resize-none"></textarea>
                        <div id="action-buttons" class="flex flex-wrap gap-3"></div>
                    </div>
                </div>

                <div id="export-container" class="hidden">
                    <button id="export-json-btn"
                        class="w-full py-4 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-2xl shadow-xl shadow-indigo-500/20 transition-all active:scale-[0.98] flex items-center justify-center gap-3">
                        <i data-lucide="download" class="w-5 h-5"></i>
                        Export as JSON
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="toast-container"></div>

    <script type="module">
        import { getCurrentUser, getRequestById } from '../js/storage.js';
        import { formatDate, showToast, redirect } from '../js/utils.js';
        import { handleTeacherAction } from '../js/teacher.js';
        import { handleHodAction } from '../js/hod.js';

        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const requestId = urlParams.get('id');

            let user = getCurrentUser();
            if (!user) user = { name: 'Guest', role: 'student' };

            const backPath = user.role === 'student' ? 'student-dashboard.html' :
                user.role === 'teacher' ? 'teacher-dashboard.html' :
                    'hod-dashboard.html';

            document.getElementById('back-btn').addEventListener('click', () => redirect(backPath));

            if (!requestId) {
                showToast('No request ID provided.', 'error');
                redirect(backPath);
                return;
            }

            const request = getRequestById(requestId);
            if (!request) {
                showToast('Request not found.', 'error');
                redirect(backPath);
                return;
            }

            renderRefinedDetails(request);
            renderActionPanel(request, user);
            setupExport(request);

            if (typeof lucide !== 'undefined') lucide.createIcons();
        });

        function renderRefinedDetails(request) {
            const titleEl = document.getElementById('detail-title');
            titleEl.textContent = `${request.requestType} Request Details`;

            document.getElementById('detail-student-name').textContent = request.studentName || 'Unknown';
            document.getElementById('detail-request-id').textContent = request.requestId;

            const dateStr = `${formatDate(request.fromDate)} to ${formatDate(request.toDate)} (${request.noOfDays} days)`;
            document.getElementById('detail-date-summary').textContent = dateStr;

            document.getElementById('detail-subject').textContent = request.subject || 'No Subject';
            document.getElementById('detail-reason').textContent = request.reason || 'No description provided.';
            document.getElementById('detail-applied-date').textContent = formatDate(request.appliedDate);
            document.getElementById('detail-dept').textContent = request.dept || 'N/A';
            document.getElementById('detail-student-regno').textContent = request.studentRegNo || request.regNo || 'N/A';

            const statusBadge = document.getElementById('status-badge-custom');
            statusBadge.textContent = request.status;

            // Stylize badge based on status
            if (request.status.includes('Approved')) {
                statusBadge.className = "w-full py-2 px-6 rounded-full text-center font-bold text-lg bg-green-950/50 text-green-400 border border-green-500/50";
            } else if (request.status.includes('Rejected')) {
                statusBadge.className = "w-full py-2 px-6 rounded-full text-center font-bold text-lg bg-red-950/50 text-red-400 border border-red-500/50";
            } else {
                statusBadge.className = "w-full py-2 px-6 rounded-full text-center font-bold text-lg bg-yellow-950/50 text-yellow-400 border border-yellow-500/50";
            }
        }

        function renderActionPanel(request, user) {
            const actionPanel = document.getElementById('action-panel');
            const actionButtonsContainer = document.getElementById('action-buttons');
            const actionTitle = document.getElementById('action-title');

            if ((user.role === 'teacher' && (request.status === "Pending" || request.status === "Pending Teacher Approval")) ||
                (user.role === 'hod' && request.status === "Forwarded to HOD")) {

                actionPanel.classList.remove('hidden');
                const isHod = user.role === 'hod';
                actionTitle.textContent = isHod ? 'HOD Final Decision' : 'Teacher Verification';

                const handler = isHod ? handleHodAction : handleTeacherAction;
                const buttons = isHod ? [
                    { action: 'approve', text: 'Approve & Finalize', color: 'bg-green-600 hover:bg-green-700' },
                    { action: 'reject', text: 'Reject Request', color: 'bg-red-600 hover:bg-red-700' }
                ] : [
                    { action: 'approve', text: 'Quick Approve', color: 'bg-green-600 hover:bg-green-700' },
                    { action: 'forward', text: 'Forward to HOD', color: 'bg-indigo-600 hover:bg-indigo-700' },
                    { action: 'reject', text: 'Reject Request', color: 'bg-red-600 hover:bg-red-700' }
                ];

                buttons.forEach(({ action, text, color }) => {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = `flex-1 px-4 py-3 rounded-xl font-bold text-white transition-all shadow-lg ${color}`;
                    btn.textContent = text;
                    btn.onclick = () => handler(request.requestId, action, document.getElementById('remark').value);
                    actionButtonsContainer.appendChild(btn);
                });
            }
        }

        function setupExport(request) {
            const exportContainer = document.getElementById('export-container');
            const exportBtn = document.getElementById('export-json-btn');

            if (request.status === "Approved by HOD") {
                exportContainer.classList.remove('hidden');
                exportBtn.onclick = () => {
                    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(request, null, 2));
                    const downloadAnchorNode = document.createElement('a');
                    downloadAnchorNode.setAttribute("href", dataStr);
                    downloadAnchorNode.setAttribute("download", `request_${request.requestId}.json`);
                    document.body.appendChild(downloadAnchorNode);
                    downloadAnchorNode.click();
                    downloadAnchorNode.remove();
                    showToast('Exporting request as JSON...', 'success');
                };
            }
        }
    </script>
</body>